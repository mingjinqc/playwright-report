name: Generate Allure & Static Reports

on:
  push:
    branches: [main]
    paths:
      - "username.json"

jobs:
  run-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          python -m playwright install --with-deps chromium

      - name: Run Playwright test and generate reports
        run: |
          pytest main.py --alluredir=allure-results
          allure generate allure-results --clean -o docs

      - name: Add static summary button to Allure index.html
        run: |
          REPORT_HTML_LINK='<a href="report.html" target="_blank" style="position:fixed;top:20px;right:20px;padding:10px 16px;background:#4CAF50;color:#fff;border-radius:6px;text-decoration:none;font-weight:bold;">ðŸ“˜ View Static Summary</a>'
          sed -i "s|</body>|${REPORT_HTML_LINK}</body>|" docs/index.html || echo "Index modification failed"

      - name: Commit and push reports
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add docs/ || true
          git commit -m "Update Allure + Static reports [skip ci]" || true
          git push
